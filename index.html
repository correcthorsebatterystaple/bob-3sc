<!DOCTYPE html>
<html>
  <head>
    <script
      src="https://accounts.google.com/gsi/client"
      onload="initClient()"
      async
      defer
    ></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"
      integrity="sha512-WFN04846sdKMIP5LKNphMaWzU7YpMyCU245etK3g/2ARYbPK9Ub18eG+ljU96qKRCWh+quCY7yefSmlkQw1ANQ=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
  </head>
  <body>
    <script>
      const ACCESS_TOKEN_KEY = "bob.g_access_token";

      let client;
      let access_token;

      function initClient() {
        client = google.accounts.oauth2.initTokenClient({
          client_id:
            "106113587711-4v9qoovue479a15nva7masil8n92v4uv.apps.googleusercontent.com",
          scope: "https://www.googleapis.com/auth/spreadsheets.readonly",
          callback: (tokenResponse) => {
            access_token = tokenResponse.access_token;
            document.getElementById("login-btn").disabled = true;
            document.getElementById("fetch-btn").disabled = false;
            document.getElementById("logout-btn").disabled = false;
          },
        });
      }
      function getToken() {
        client.requestAccessToken();
      }
      function revokeToken() {
        google.accounts.oauth2.revoke(access_token, () => {
          console.log("access token revoked");
          access_token = null;
          document.getElementById("login-btn").disabled = false;
          document.getElementById("fetch-btn").disabled = true;
          document.getElementById("logout-btn").disabled = true;
        });
      }

      const spreadsheetId = "1ATMcPmXNQlVXdOQv95kJHbQn1dJJMszF7Y71sLpqGgA";
      const baseSheetsUrl = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}`;
      const month = new Date()
        .toLocaleString("default", { month: "short" })
        .toUpperCase();

      async function renderSchedule() {
        const name = document.getElementById("name-input").value;
        if (!name) {
          alert("no name");
          return;
        }

        const amTextDisplay = document.getElementById("am-text");
        const amColorDisplay = document.getElementById("am-color");

        const pmTextDisplay = document.getElementById("pm-text");
        const pmColorDisplay = document.getElementById("pm-color");

        amTextDisplay.innerText = "Fetching Schedule...";
        pmTextDisplay.innerText = "Fetching Schedule...";

        document.getElementById("fetch-btn").disabled = true;

        const schedule = await getScheduledEntry(name).catch((e) => {
          console.error(e);
          amTextDisplay.innerText = "Something went wrong...";
          pmTextDisplay.innerText = "Check console for error";
        });

        const { am, pm } = schedule;

        document.getElementById("fetch-btn").disabled = false;

        amTextDisplay.innerText = am.key;
        const amColor = {
          red: (am.value.color.red ?? 0) * 255,
          green: (am.value.color.green ?? 0) * 255,
          blue: (am.value.color.blue ?? 0) * 255,
        };
        amColorDisplay.style.backgroundColor = `rgb(${amColor.red}, ${amColor.green}, ${amColor.blue})`;
        amColorDisplay.innerText = am.value.value;

        pmTextDisplay.innerText = pm.key;
        const pmColor = {
          red: (pm.value.color.red ?? 0) * 255,
          green: (pm.value.color.green ?? 0) * 255,
          blue: (pm.value.color.blue ?? 0) * 255,
        };
        pmColorDisplay.style.backgroundColor = `rgb(${pmColor.red}, ${pmColor.green}, ${pmColor.blue})`;
        pmColorDisplay.innerText = pm.value.value;
      }

      async function getScheduledEntry(name) {
        if (!access_token) {
          alert("no access token");
          return;
        }

        const [rowNumber, columnNumber, keys] = await Promise.all([
          getRowNumber(name),
          getColumnNumber(),
          getKeys(),
        ]);

        const [cellAM, cellPM] = await getCell(rowNumber, columnNumber);
        const isHoliday = (cell) => Object.keys(cell.color).length === 0;

        let scheduleAM = keys.find(
          (k) =>
            k.value.value === cellAM.value &&
            _.isEqual(k.value.color, cellAM.color)
        );
        let schedulePM = keys.find(
          (k) =>
            k.value.value === cellPM.value &&
            _.isEqual(k.value.color, cellPM.color)
        );

        if (isHoliday(cellAM)) {
          scheduleAM = {
            key: "Holiday",
            value: { value: cellAM.value, color: {} },
          };
        }
        if (isHoliday(cellPM)) {
          schedulePM = {
            key: "Holiday",
            value: { value: cellPM.value, color: {} },
          };
        }

        return {
          am: scheduleAM,
          pm: schedulePM,
        };
      }

      /**
       * @param {string} name
       * @returns {Promise<{key: string; value: {value: string, color: any}}[]>}
       */
      async function getKeys() {
        const sheet = month;
        const ranges = [`KEY!A2:B31`, "KEY!A34:B48", "KEY!D2:E9"];

        const keysData = await axios
          .get(
            `${baseSheetsUrl}?ranges=${ranges[0]}&ranges=${ranges[1]}&ranges=${ranges[2]}&fields=sheets.data.rowData.values(effectiveFormat,effectiveValue)`,
            {
              headers: { Authorization: `Bearer ${access_token}` },
            }
          )
          .then((res) => res.data.sheets[0].data);

        const keys = keysData
          .map((d) =>
            d.rowData.map((rd) => ({
              key: rd.values[0].effectiveValue.stringValue,
              value: {
                value: rd.values[1].effectiveValue?.stringValue ?? "",
                color: rd.values[1].effectiveFormat?.backgroundColor,
              },
            }))
          )
          .flat();

        return keys;
      }

      /**
       * @param {number} row
       * @param {number} col
       * @returns {Promise<{value: string, color: {red: number, green: number, blue: number}}[]>}
       */
      async function getCell(row, col) {
        const colLetterAM = columnNumberToIndex(col);
        const colLetterPM = columnNumberToIndex(col + 1);

        const range = `${month}!${colLetterAM}${row}:${colLetterPM}${row}`;
        const cells = await axios
          .get(
            `${baseSheetsUrl}?ranges=${range}&fields=sheets.data.rowData.values(effectiveFormat,effectiveValue)`,
            {
              headers: { Authorization: `Bearer ${access_token}` },
            }
          )
          .then(
            (response) => response.data.sheets[0].data[0].rowData[0].values
          );

        return cells.map((c) => ({
          value: c.effectiveValue?.stringValue ?? "",
          color: c.effectiveFormat.backgroundColor,
        }));
      }

      async function getRowNumber(name) {
        // get the row number corresponding to the name
        const sheet = month;
        const range = `${sheet}!B:B`;

        const names = await axios
          .get(`${baseSheetsUrl}/values/${range}?majorDimension=COLUMNS`, {
            headers: {
              Authorization: `Bearer ${access_token}`,
            },
          })
          .then((response) => response.data.values);

        const nameIndex = names[0].findIndex(
          (n) => n?.toLowerCase() === name.toLowerCase()
        );

        return nameIndex === -1 ? null : nameIndex + 1;
      }

      async function getColumnNumber() {
        const sheet = month;
        const range = `${sheet}!2:2`;

        const dates = await axios
          .get(`${baseSheetsUrl}?ranges=${range}&includeGridData=true`, {
            headers: {
              Authorization: `Bearer ${access_token}`,
            },
          })
          .then(
            (response) => response.data.sheets[0].data[0].rowData[0].values
          );

        const now = new Date();
        const index = dates.findIndex(
          (d) => d?.effectiveValue?.numberValue === now.getDate()
        );

        return index === -1 ? null : index + 1;
      }

      /**
       * Converts a column number to an alphabetical index
       * @param {number} columnNumber
       * @returns {string} The aphabetical column index
       */
      function columnNumberToIndex(columnNumber) {
        if (columnNumber <= 0) {
          return "";
        }
        const remainder = (columnNumber - 1) % 26;
        return (
          columnNumberToIndex(Math.floor((columnNumber - 1) / 26)) +
          String.fromCharCode(65 + remainder)
        );
      }
    </script>
    <div
      style="
        max-width: 768px;
        padding: 2rem;
        margin: auto;
        display: flex;
        flex-direction: column;
      "
    >
      <input
        id="name-input"
        style="
          text-align: center;
          font-size: xx-large;
          margin: 10px auto;
          max-width: 350px;
        "
        placeholder="Enter your name"
      />
      <div style="display: flex; justify-content: space-around">
        <button onclick="getToken();" id="login-btn">Login</button><br /><br />
        <button onclick="renderSchedule();" disabled id="fetch-btn">
          Fetch schedule</button
        ><br /><br />
        <button onclick="revokeToken();" disabled id="logout-btn">
          Logout
        </button>
      </div>
      <table style="margin: 20px auto">
        <tr>
          <td>AM -</td>
          <td id="am-text"></td>
          <td id="am-color" style="width: 40px; text-align: center"></td>
        </tr>
        <tr>
          <td>PM -</td>
          <td id="pm-text"></td>
          <td id="pm-color" style="width: 40px; text-align: center"></td>
        </tr>
      </table>
    </div>
  </body>
</html>
